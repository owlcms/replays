name: Release owlcms-replays

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., 1.9.0, 1.9.0-beta1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build_replays:
    runs-on: ubuntu-latest
    env:
      BUILD_WINDOWS: false   # temporarily disabled
      BUILD_RASPBERRY: true
      BUILD_LINUX: false     # temporarily disabled

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Install fyne-cross
      run: |
        go install github.com/fyne-io/fyne-cross@latest
        echo "${HOME}/go/bin" >> $GITHUB_PATH

    - name: Extract tag
      id: extract_tag
      run: |
        echo "TAG=${{ inputs.tag }}" >> $GITHUB_ENV
        VERSION="${{ inputs.tag }}"
        VERSION="${VERSION#v}"
        echo "VERSION=${VERSION}" >> $GITHUB_ENV

    - name: Substitute tag in version.go
      run: |
        cp dist/version.go.template internal/config/version.go
        sed -i "s/_TAG_/${TAG}/g" internal/config/version.go
        cat internal/config/version.go

    - name: Build replays for Linux amd64
      if: ${{ env.BUILD_LINUX == 'true' }}
      run: |
        mkdir -p artifacts
        fyne-cross linux -arch amd64 -name replays -app-id app.owlcms.replays -icon Icon.png ./cmd/replays
        cp fyne-cross/bin/linux-amd64/replays artifacts/replays_linux_amd64

    - name: Build replays for Linux arm64
      if: ${{ env.BUILD_RASPBERRY == 'true' }}
      run: |
        mkdir -p artifacts
        fyne-cross linux -arch arm64 -name replays -app-id app.owlcms.replays -icon Icon.png ./cmd/replays
        cp fyne-cross/bin/linux-arm64/replays artifacts/replays_linux_arm64

    - name: Build replays for Windows
      if: ${{ env.BUILD_WINDOWS == 'true' }}
      run: |
        mkdir -p artifacts
        fyne-cross windows -arch amd64 -name replays -app-id app.owlcms.replays -icon Icon.png ./cmd/replays
        cp fyne-cross/bin/windows-amd64/replays.exe artifacts/replays_windows.exe

    - name: Upload replays artifacts
      uses: actions/upload-artifact@v4
      with:
        name: replays_artifacts
        path: artifacts/*

  build_cameras:
    runs-on: ubuntu-latest
    env:
      BUILD_WINDOWS: false   # temporarily disabled
      BUILD_RASPBERRY: true
      BUILD_LINUX: false     # temporarily disabled

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Install fyne-cross
      run: |
        go install github.com/fyne-io/fyne-cross@latest
        echo "${HOME}/go/bin" >> $GITHUB_PATH

    - name: Build cameras for Linux amd64
      if: ${{ env.BUILD_LINUX == 'true' }}
      run: |
        mkdir -p artifacts
        fyne-cross linux -arch amd64 -name cameras -app-id app.owlcms.cameras -icon Icon.png ./cmd/cameras
        cp fyne-cross/bin/linux-amd64/cameras artifacts/cameras_linux_amd64

    - name: Build cameras for Linux arm64
      if: ${{ env.BUILD_RASPBERRY == 'true' }}
      run: |
        mkdir -p artifacts
        fyne-cross linux -arch arm64 -name cameras -app-id app.owlcms.cameras -icon Icon.png ./cmd/cameras
        cp fyne-cross/bin/linux-arm64/cameras artifacts/cameras_linux_arm64

    - name: Build cameras for Windows
      if: ${{ env.BUILD_WINDOWS == 'true' }}
      run: |
        mkdir -p artifacts
        fyne-cross windows -arch amd64 -name cameras -app-id app.owlcms.cameras -icon Icon.png ./cmd/cameras
        cp fyne-cross/bin/windows-amd64/cameras.exe artifacts/cameras_windows.exe

    - name: Upload cameras artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cameras_artifacts
        path: artifacts/*

  create_release:
    runs-on: ubuntu-latest
    needs: [build_replays, build_cameras]
    env:
      BUILD_WINDOWS: false   # temporarily disabled
      BUILD_RASPBERRY: true
      BUILD_LINUX: false     # temporarily disabled

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install GitHub CLI
      run: |
        wget https://github.com/cli/cli/releases/download/v2.32.0/gh_2.32.0_linux_amd64.deb
        sudo dpkg -i gh_2.32.0_linux_amd64.deb

    - name: Extract tag
      id: extract_tag
      run: |
        echo "TAG=${{ inputs.tag }}" >> $GITHUB_ENV

    - name: Create dist directory
      run: mkdir -p dist

    - name: Prepare release notes
      run: |
        cp ReleaseNotes.md ./dist/ReleaseNotes.md
        sed -i "s/_TAG_/${TAG}/g" ./dist/ReleaseNotes.md

    - name: Download replays artifacts
      uses: actions/download-artifact@v4
      with:
        name: replays_artifacts
        path: ./dist

    - name: Download cameras artifacts
      uses: actions/download-artifact@v4
      with:
        name: cameras_artifacts
        path: ./dist

    - name: List artifacts
      run: ls -la ./dist

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: bash
      run: |
        if [[ "${TAG}" == *"-"* ]]; then
          gh release create ${{ env.TAG }} \
            --title "owlcms jury replays ${{ env.TAG }}" \
            --notes-file ./dist/ReleaseNotes.md \
            --prerelease
        else
          gh release create ${{ env.TAG }} \
            --title "owlcms jury replays ${{ env.TAG }}" \
            --notes-file ./dist/ReleaseNotes.md
        fi

    # Upload replays executables
    - name: Upload Windows replays executable
      if: ${{ env.BUILD_WINDOWS == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ env.TAG }} dist/replays_windows.exe

    - name: Upload Linux amd64 replays executable
      if: ${{ env.BUILD_LINUX == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ env.TAG }} dist/replays_linux_amd64

    - name: Upload Raspberry Pi arm64 replays executable
      if: ${{ env.BUILD_RASPBERRY == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ env.TAG }} dist/replays_linux_arm64

    # Upload cameras executables
    - name: Upload Windows cameras executable
      if: ${{ env.BUILD_WINDOWS == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ env.TAG }} dist/cameras_windows.exe

    - name: Upload Linux amd64 cameras executable
      if: ${{ env.BUILD_LINUX == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ env.TAG }} dist/cameras_linux_amd64

    - name: Upload Raspberry Pi arm64 cameras executable
      if: ${{ env.BUILD_RASPBERRY == 'true' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ env.TAG }} dist/cameras_linux_arm64
